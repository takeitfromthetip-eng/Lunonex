#!/bin/sh

# üõ°Ô∏è PRE-PUSH SAFETY CHECKS
# This runs BEFORE code is pushed to GitHub

echo ""
echo "üõ°Ô∏è  Running pre-push safety checks..."
echo ""

# 1. Create automatic backup
echo "üíæ Creating backup before push..."
node scripts/auto-backup.js

# 2. Check for critical files
echo ""
echo "üîç Verifying critical files exist..."

critical_files=(
  "package.json"
  "vite.config.mjs"
  "src/index.jsx"
  ".env"
  "server.js"
)

for file in "${critical_files[@]}"; do
  if [ ! -f "$file" ]; then
    echo "‚ùå CRITICAL FILE MISSING: $file"
    echo "‚ùå PUSH BLOCKED!"
    exit 1
  fi
done

echo "‚úÖ All critical files present"

# 3. Validate package.json
echo ""
echo "üîç Validating package.json..."
node -e "JSON.parse(require('fs').readFileSync('package.json'))" 2>/dev/null
if [ $? -ne 0 ]; then
  echo "‚ùå package.json is corrupted!"
  echo "‚ùå PUSH BLOCKED!"
  exit 1
fi
echo "‚úÖ package.json is valid"

# 4. Check for .env in staging (prevent accidental commit)
if git diff --cached --name-only | grep -q "^\.env$"; then
  echo ""
  echo "‚ö†Ô∏è  WARNING: You are trying to commit .env file!"
  echo "This file contains secrets and should NOT be pushed to GitHub!"
  echo ""
  read -p "Do you want to continue anyway? (yes/no): " confirm
  if [ "$confirm" != "yes" ]; then
    echo "‚ùå PUSH BLOCKED - .env file removed from staging"
    git reset HEAD .env
    exit 1
  fi
fi

# 5. Verify build still works (DISABLED for speed)
echo ""
echo "‚ö° Skipping build test (too slow)"
echo "‚úÖ Build test disabled - push proceeding"

# 6. Final confirmation for main branch
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
  echo ""
  echo "üö® You are pushing to $CURRENT_BRANCH branch!"
  echo ""
  read -p "Are you sure you want to push to production? (yes/no): " confirm
  if [ "$confirm" != "yes" ]; then
    echo "‚ùå Push cancelled"
    exit 1
  fi
fi

echo ""
echo "‚úÖ All pre-push checks passed!"
echo "üöÄ Pushing to GitHub..."
echo ""

exit 0
