name: ğŸš€ Deploy & Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Prevent concurrent deployments
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  # ğŸ”‘ Expand Node.js heap to 4GB - prevents OOM kills
  NODE_OPTIONS: '--max-old-space-size=4096'
  # Limit npm concurrency to prevent socket/file descriptor exhaustion
  NPM_CONFIG_MAXSOCKETS: 5

jobs:
  test:
    name: ğŸ§ª Test & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: ğŸ’¾ Setup 4GB Swap (Prevents Memory Kills)
        run: |
          echo "ğŸ”§ Creating 4GB swap file..."
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "âœ… Swap enabled:"
          free -h
        
      - name: ğŸ“Š Log System Resources
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ–¥ï¸  SYSTEM RESOURCES AT START"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "CPU Info:"
          lscpu | grep -E '^CPU\(s\)|^Model name'
          echo ""
          echo "Memory:"
          free -h
          echo ""
          echo "Disk:"
          df -h /
          echo ""
          echo "File Descriptors:"
          ulimit -n
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Restore npm cache
        id: npm-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
          
      - name: ğŸ“š Install Dependencies
        run: |
          echo "ğŸ“¥ Installing with legacy peer deps..."
          npm install --legacy-peer-deps --prefer-offline --no-audit
          echo "âœ… Dependencies installed"
        
      - name: ğŸ” Lint Code
        run: npm run lint --if-present
        continue-on-error: true
        
      - name: ğŸ§ª Run Tests
        run: npm test --if-present
        continue-on-error: true
        
      - name: ğŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage/
            test-results/
          retention-days: 30

  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: ğŸ’¾ Setup 4GB Swap (Prevents Memory Kills)
        run: |
          echo "ğŸ”§ Creating 4GB swap file..."
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "âœ… Swap enabled:"
          free -h
        
      - name: ğŸ“Š Log System Resources
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ–¥ï¸  BUILD RESOURCES AT START"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "CPU Info:"
          lscpu | grep -E '^CPU\(s\)|^Model name'
          echo ""
          echo "Memory:"
          free -h
          echo ""
          echo "Disk:"
          df -h /
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Restore npm cache
        id: npm-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
          
      - name: ğŸ“š Install Dependencies
        run: |
          echo "ğŸ“¥ Installing with legacy peer deps..."
          npm install --legacy-peer-deps --prefer-offline --no-audit
          echo "âœ… Dependencies installed"
          
      - name: ğŸ“Š Monitor Resources After Install
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RESOURCES AFTER INSTALL"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Memory Usage:"
          free -h
          echo ""
          echo "Disk Usage:"
          df -h /
          echo ""
          echo "Node Processes:"
          ps aux | grep node || echo "No Node processes"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
      - name: ğŸ” Verify React Deduplication
        run: |
          echo "ğŸ” Checking for React duplication..."
          npm list react react-dom --depth=0 || true
          echo "âœ… React check complete"
        
      - name: ğŸ—ï¸ Build Project
        run: |
          echo "ğŸ—ï¸ Starting production build..."
          echo "NODE_OPTIONS: $NODE_OPTIONS"
          npm run build
          echo "âœ… Build complete!"
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_STRIPE_PUBLIC_KEY: ${{ secrets.VITE_STRIPE_PUBLIC_KEY }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          
      - name: ğŸ“Š Build Artifact Stats
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ BUILD ARTIFACT STATISTICS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Dist folder size:"
          du -sh dist/
          echo ""
          echo "Largest files:"
          find dist/ -type f -exec ls -lh {} \; | sort -k5 -hr | head -10
          echo ""
          echo "Total file count:"
          find dist/ -type f | wc -l
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
      - name: ğŸ“Š Final Resource Check
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¯ FINAL RESOURCE STATE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Memory:"
          free -h
          echo ""
          echo "Swap Usage:"
          swapon --show
          echo ""
          echo "Disk:"
          df -h /
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
      - name: ğŸ“Š Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.sha }}
          path: dist/
          retention-days: 30
          
      - name: âŒ Cleanup on Failure
        if: failure()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ BUILD FAILED - DIAGNOSTICS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Last 100 lines of npm log:"
          tail -100 ~/.npm/_logs/*.log 2>/dev/null || echo "No npm logs found"
          echo ""
          echo "Memory at failure:"
          free -h
          echo ""
          echo "Disk at failure:"
          df -h /
          echo ""
          echo "Node processes at failure:"
          ps aux | grep node || echo "No Node processes"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
  deploy-log:
    name: ğŸ“ Log Deployment
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“ Create Sovereign Deployment Artifact Log
        run: |
          mkdir -p artifacts
          
          # Create JSON artifact log (machine-readable)
          cat > artifacts/deployment-log.json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "commit_short": "$(echo ${{ github.sha }} | cut -c1-7)",
            "ref": "${{ github.ref }}",
            "branch": "${{ github.ref_name }}",
            "actor": "${{ github.actor }}",
            "event": "${{ github.event_name }}",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "repository": "${{ github.repository }}",
            "node_version": "20.x",
            "npm_version": "latest",
            "commit_message": "${{ github.event.head_commit.message }}",
            "urls": {
              "vercel": "https://fortheweebs.vercel.app",
              "railway": "https://fortheweebs-production.up.railway.app"
            },
            "sovereignty_note": "Every deployment is a ritualized sovereign event"
          }
          EOF
          
          # Create Markdown log (human-readable)
          echo "## ğŸš€ Sovereign Deployment Artifact" > artifacts/deploy-log.md
          echo "" >> artifacts/deploy-log.md
          echo "### ğŸ“Š Deployment Metadata" >> artifacts/deploy-log.md
          echo "| Property | Value |" >> artifacts/deploy-log.md
          echo "|----------|-------|" >> artifacts/deploy-log.md
          echo "| **Commit** | \`${{ github.sha }}\` |" >> artifacts/deploy-log.md
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> artifacts/deploy-log.md
          echo "| **Timestamp** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> artifacts/deploy-log.md
          echo "| **Author** | ${{ github.actor }} |" >> artifacts/deploy-log.md
          echo "| **Event** | ${{ github.event_name }} |" >> artifacts/deploy-log.md
          echo "| **Run** | #${{ github.run_number }} |" >> artifacts/deploy-log.md
          echo "" >> artifacts/deploy-log.md
          echo "### ğŸŒ Deployment URLs" >> artifacts/deploy-log.md
          echo "- **Vercel**: https://fortheweebs.vercel.app" >> artifacts/deploy-log.md
          echo "- **Railway API**: https://fortheweebs-production.up.railway.app" >> artifacts/deploy-log.md
          echo "" >> artifacts/deploy-log.md
          echo "### ğŸ“ Commit Message" >> artifacts/deploy-log.md
          echo "\`\`\`" >> artifacts/deploy-log.md
          echo "${{ github.event.head_commit.message }}" >> artifacts/deploy-log.md
          echo "\`\`\`" >> artifacts/deploy-log.md
          echo "" >> artifacts/deploy-log.md
          echo "---" >> artifacts/deploy-log.md
          echo "*ğŸ›ï¸ Deployed via GitHub Actions - Every deployment is a sovereign event*" >> artifacts/deploy-log.md
          
          echo "ğŸ“ Deployment artifact logs created"
          cat artifacts/deployment-log.json
          
      - name: ğŸ“Š Upload Deploy Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log-${{ github.sha }}
          path: artifacts/
          retention-days: 90
          
  verify:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-log
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ” Check Vercel Deployment
        run: |
          echo "Checking Vercel deployment..."
          curl -f https://fortheweebs.vercel.app || echo "âš ï¸ Vercel deployment not reachable"
          
      - name: ğŸ” Check Railway Backend
        run: |
          echo "Checking Railway backend..."
          curl -f https://fortheweebs-production.up.railway.app/api/status || echo "âš ï¸ Railway backend not reachable"
          
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [test, build, deploy-log, verify]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¢ Deployment Summary
        run: |
          echo "ğŸš€ Deployment Complete"
          echo "Commit: ${{ github.sha }}"
          echo "Status: ${{ job.status }}"
          echo "View at: https://fortheweebs.vercel.app"
