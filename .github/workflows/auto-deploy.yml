name: Auto-Deploy Fixes

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

jobs:
  auto-deploy:
    # Only run for auto-generated PRs from Claude
    if: startsWith(github.event.pull_request.title, 'ü§ñ Auto-fix') || startsWith(github.event.pull_request.title, '‚ú® Feature')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || true
        continue-on-error: true

      - name: Run tests
        run: npm test || true
        continue-on-error: true

      - name: Build project
        run: npm run build

      - name: Auto-merge if build succeeds
        if: success()
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --auto --squash --delete-branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR if build fails
        if: failure()
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "‚ö†Ô∏è Auto-merge blocked: Build failed. Manual review required."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
